{"title":"toc: true","markdown":{"headingText":"    toc: true","containsRefs":false,"markdown":"\n<div class=\"colab-button-container\">\n  <a href=\"https://colab.research.google.com/drive/1CUDyNMz2TQrY2Ekpco1aWJ-ibvSVdIRF?usp=sharing\"\n     target=\"_blank\"\n     class=\"colab-top-button\"\n     title=\"Open this notebook in Google Colab\">\n    <img src=\"https://colab.research.google.com/assets/colab-badge.svg\"\n         alt=\"Open in Colab\"\n         class=\"colab-badge\">\n  </a>\n</div>\n\n---\nformat:\n  html:\n    page-layout: full\n    mainfont: \"Inter\"\n\n<h1>Introductory scRNA-seq Analysis with `kb-python` and `Scanpy`</h1>\n<h4>Written by Maya Caskey (based off older versions by Joe Rich, Kyung Hoi (Joseph) Min, A. Sina Booeshaghi and Lior Pachter)</h4>\n<br>\n\nThis notebook demonstrates pre-processing and basic analysis of the [1k Human PBMCs](https://www.10xgenomics.com/datasets/1-k-human-pbm-cs-stained-with-a-panel-of-total-seq-b-antibodies-single-indexed-3-1-standard-4-0-0) dataset from 10x Genomics using the **10x Genomics Chromium Single Cell 3' Next Gen v3.1** assay.\n\n## An Introductory Analysis Workflow\n\nThere are many ways to perform a single-cell RNA sequencing (scRNA-seq) analysis and many aspects of your data to explore. In this tutorial, we outline a basic approach to quality control and analysis, along with some intuitive explanation of the underlying mathematics.\n\n:::{.highlight-section}\nThis scRNA-seq workflow has the following steps:\n\n1. Read Pseudoalignment\n2. Quality Control\n3. Cell and Gene Filters\n4. Normalization and Variance Stabilization\n5. Dimensionality Reduction\n6. Clustering and Visualization\n7. Differential Expression\n:::\n\n## Initial Set-Up\n\n### Install Python Packages\n\n### Download the scRNA-seq data\n\n## Step 1: Read Pseudoalignment\n\n### Download a Pre-Built Index with `kb ref`\n\n### Pseudoalign the scRNA-seq Data to the Index with `kb count`\n\nWhen the `--h5ad` argument is used, `kb count` generates a H5AD-formatted Anndata matrix for downstream processing.\n\n### Load the Anndata Object\n\nFor this tutorial we will be using the Python package [**Scanpy**](https://scanpy.readthedocs.io/en/stable/).\n\nScanpy is a scalable Python library for analyzing single-cell RNA sequencing (scRNA-seq) data, built around an efficient [**AnnData**](https://anndata.readthedocs.io/en/stable/) object that stores expression matrices and associated metadata. It provides a comprehensive toolkit for preprocessing, visualization, clustering, and differential expression, enabling end-to-end analysis of large single-cell datasets.\n\nBelow we load the *cells x genes* matrix generated by kb-python as a H5AD-formatted object so that we can analyze our data with Scanpy.\n\n## Step 2: Basic Quality Control\n\n### Test for Library Saturation\n\nBelow is a **Gene vs. UMI plot**, in which, for each cell, we visualize how many genes we detected. The purpose of this plot is to see if we have \"saturated\" our sequencing library and sampled a representative number of mRNA molecules for each cell. If this is the case, the curve should plateau as we sequence more UMIs.\n\nThe number of genes detected continues to increase with the number of UMI counts (x-axis) indicating that we have not saturated our library. More sequencing would likely yield more genes detected per cell.\n\n### Examine the Knee Plot\n\nIn **microfluidics-based scRNA-seq assays**, such as the 10x Genomics Chromium platform, cells are encapsulated into droplets at low concentrations to minimize the formation of **multiplets** (droplets containing more than one cell). However, this approach also results in many droplets that contain no cells at all.\n\nDuring cell dissociation and droplet generation, some mRNA molecules are released into the surrounding solution — known as **ambient RNA**. When this ambient RNA is captured and sequenced, **empty droplets** may falsely appear to contain a cell.\n\nThe **knee plot** helps distinguish real cells from empty droplets based on total UMI counts per droplet. It was first introduced in the [Drop-seq paper by Macosko et al., 2015](https://www.cell.com/fulltext/S0092-8674(15)00549-8).\n\nIn this plot, barcodes (droplets) are ranked by the number of associated UMI counts (shown on the x-axis), while the fraction of droplets with at least that many UMIs is shown on the y-axis. The “knee” of the curve represents the point where UMI counts drop sharply — separating droplets that likely contain real cells from those containing only ambient RNA.\n\nThe knee plot can be used to threshold cells based on the number of UMI counts they contain. In this example we use the number 3979 based on the publication describing the data.\n\n## Step 3: Doublet and Multiplet Removal\n\n### Filter empty droplets (According to the Knee Plot)\n\nIdeally, your data will contain no empty droplets that can be mistaken for real cells. We use our results from the knee plot here to filter them out.\n\n:::{.callout-note}\nThe knee plot is a very simple method for getting rid of empty droplets. More sophisticated methods also exist. For instance, the methods **EmptyDrops**, [**CellBender**](https://github.com/broadinstitute/CellBender), and [**DecontX**](https://bioconductor.org/packages/release/bioc/html/decontX.html) use a statistical model to distinguish counts from ambient vs. cellular mRNA. This allows for both the identification and removal of empty droplets and the removal of technical noise from your count data.\n:::\n\n### Filter Multiplets with Scrublet\n\n[**Scrublet**](https://github.com/swolock/scrublet) is an package designed to identify and remove multiplets (droplets containing more than one cell) from scRNA-seq data. It works by simulating artificial doublets through random pairwise combinations of real cells’ expression profiles. Scrublet then embeds both the simulated and observed cells in a low-dimensional space and flags real cells that lie close to simulated doublets as potential multiplets.\n\nScrublet operates on a raw count matrix, but requires that empty droplets be removed beforehand. If empty droplets remain in the dataset, they can distort the simulated doublet distribution and lead to inaccurate classifications. In addition, the Scrublet package should be applied to each sample/batch individually to avoid batch effects distorting the simulated doublet distribution.\n\nRemoving multiplets is an important quality-control step, as doublets can appear as hybrid cell types and obscure true biological variation during clustering and downstream analyses.\n\n:::{.callout-note}\nThe Scrublet package is convenient because it is built-in to Scanpy, but it is not the only nor the most accurate doublet removal method. For a review of doublet detection methods, refer to the paper [Benchmarking computational doublet-detection methods for single-cell RNA sequencing data](https://pmc.ncbi.nlm.nih.gov/articles/PMC7897250/) by Nan Miles Chi and Jingyi Jessica Li.\n:::\n\n\nThe expected doublet rate depends upon your assay and the number of cells targeted. Refer to the documentation for you specific technology to get this number. We got the expected double rate 0.008 for 1,000 cells for 10x Chromium NextGem v3.1 [here](https://kb.10xgenomics.com/s/article/360054599512-What-is-the-cell-multiplet-rate-when-using-the-3-CellPlex-Kit-for-Cell-Multiplexing).\n\n### Filtering Cells by Mitochondrial Content\n\nA healthy, intact cell should have no miRNA in the cytoplasm. As such, a high percentage of miRNA in the cytosol indicates cellular damage. We will identify the number of miRNA in each cell and remove cells with a certain percentage of miRNA.\n\nWe see above that the highest density of cells appear to have less than 30% miRNA content, so we will set our threshold to 30%\n\n### Filter out genes that are not present in any cells\n\nIn general, we also want to get rid of genes with a low cell count to simplify our data.\n\n### Visualizing count distributions\n\nExamination of the gene count and UMI count distributions is useful QC to evaluate the quality of the library and how deeply it was sequenced.\n\n## Step 4: Normalization and Variance Stabilization\n\nIn an scRNA-seq experiment, UMI counts provide a relative estimate of transcript abundance within each cell. During library preparation and sequencing, mRNA molecules from different cells are reverse transcribed and sequenced to varying degrees. As a result, UMI counts cannot be interpreted as absolute measurements of RNA abundance.\n\nTo make counts comparable across cells, we normalize the data so that each cell has a total of 1×10⁶ counts. This scaling preserves integer values while allowing gene expression levels to be expressed as relative abundances within each cell.\n\nDownstream analyses such as PCA and differential expression typically assume that gene expression values are approximately continuous and have roughly constant variance across their range. However, raw scRNA-seq counts are **overdispersed** — they follow a negative binomial–like distribution, where the variance increases with the mean. To stabilize the variance and make the data more compatible with these methods, we apply a **log transformation** to the normalized counts.\n\n:::{.callout-note}\nThis is a simplified approach for addressing overdispersion. Although log normalization is widely used, it does entirely produce constant-variance data. More sophisticated methods (e.g., variance-stabilizing transformations or model-based approaches) can better correct for overdispersion, but no perfect method currently exists — and those techniques are beyond the scope of this tutorial.\n:::\n\n### Identify Highly Variable Genes\n\nTo simplify our data and reduce its dimensionality for downstream analyses, we limit our dataset to highly variable genes. Genes with low expression variance — such as housekeeping genes — contribute little to distinguishing between cell types or states, and can be excluded without loss of biological signal.\n\nHere, we retain only genes with a mean expression between 0.01 and 8 (values above 8 likely indicate technical artifacts) and a minimum normalized dispersion of 1. Cells are grouped (binned) by mean gene expression, and genes within each bin are filtered based on their normalized dispersion values.\n\n:::{.callout-note}\nThe `sc.pp.highly_variable_genes` function in **Scanpy** expects input data that have already been **normalized** and **variance-stabilized**.\n:::\n\nFinally, we scale the the data to unit variance and zero mean to standardize gene expression by preventing highly expressed genes from dominating downstream analysis and ensuring all genes are weighted equally.\n\n## Step 5: Clustering and Visualization\n\nWhen analyzing scRNA-seq data, **clustering** is used to identify distinct cell types and states. Subsequently, **differential expression analysis** can reveal the genes that define these cellular states.\n\nThere are many algorithms for clustering cells, and while they have been compared in detail in various benchmarks (see e.g., [Duo et al. 2018](https://f1000research.com/articles/7-1141/v2)), there is no univerally agreed upon method. Here we demonstrate clustering using **Louvain clustering**, which is a popular method for clustering single-cell RNA-seq data.\n\n:::{.callout-note}\nLouvain clustering is a non-deterministic algorithm, meaning it can produce slightly different results across runs. The number and size of clusters depend on a resolution parameter, which controls the granularity of the clustering. There is no universally optimal way to choose this parameter — it typically depends on how specific or fine-grained you want your cell populations to be.\n:::\n\nIt is useful to revisit the PCA projection with points colored by cluster. Previously we computed the PCA projection directly; here we use a function in Scanpy which does the same.\n\n### Visualization with PCA\n\n### Nonlinear Visualization\n\nThe PCA representation results from a linear projection of the data from its original high-dimensional space to a lower-dimensional one (in this case, 2D). Such projections are valuable because they preserve global structure and are mathematically well-defined and reproducible.\n\nIn contrast, non-linear dimensionality reduction methods---the most popular being **t-SNE** and **UMAP**---can reveal complex, curved relationships in the data that linear methods cannot capture. However, they distort global distances and relationships, depend heavily on algorithmic parameters and random initialization, and may produce different results across runs. As a result, they are excellent for visualization but should be interpreted cautiously and not used for quantitative downstream analysis.\n\nTo read more, please see the [Pachter Lab's paper](http://biorxiv.org/lookup/doi/10.1101/2021.08.25.457696) on the drawbacks of non-linear dimensionality reduction methods.\n\n#### t-SNE\n\n#### UMAP\n\n## Step 6: Differential Analysis\n\nFrom our clustering of cell states, we can perform **differential expression analysis** to identify **marker genes** that distinguish one cell state or cluster from another. This is typically done using simple statistical tests — such as the **Wilcoxon rank-sum test** or the **t-test** — which compare gene expression levels between clusters, or alternatively by fitting a more complex statistical model that accounts for variability across cells. By examining which genes are upregulated in each cluster, we can annotate clusters with known cell identities or infer novel cellular subpopulations.\n\nBelow, we use the **Wilcoxon rank-sum test** to identify marker genes. Because we are performing multiple hypothesis tests on the same dataset, we must adjust our p-values to control the false discovery rate. Several correction methods exist, but here we apply the **Benjamini–Hochberg procedure**, a widely used approach for multiple testing correction.\n\n:::{.callout-note}\nStatistical tests such as the **Wilcoxon rank-sum test** and the **t-test** assume that the groups being compared were defined independently of the data. However, in single-cell analysis, clustering algorithms like Louvain define groups based on the data itself — by minimizing within-cluster variation and maximizing between-cluster separation. This violates the independence assumption, meaning these tests are not strictly valid. Despite this, they remain common in practice and can still provide useful exploratory insights when interpreted cautiously.\n:::\n\nThe below plot shows the 10 most highly expressed genes in each cluster (compared to the other clusters) according to the Wilcoxon z-score.\n","srcMarkdownNoYaml":""},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":false,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"jupyter"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":"none","code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["styles.css"],"toc":true,"highlight-style":"ayu-dark","output-file":"sample_pipeline.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.8.25","theme":{"light":"flatly"},"mainfont":"Inter","fontsize":"1rem","linestretch":1.6,"toc-location":"left","page-layout":"full"},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}